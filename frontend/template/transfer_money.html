<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum DApp 5 - Transfer Money</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Ethereum DApp 5</h1>
        <h2>Welcome to Transfer Money v2</h2>
        <div id="wallet-info">
            <p>Wallet ETH Balance: <span id="wallet-eth-balance">Not Connected</span></p>
            <p>Wallet LINK Balance: <span id="wallet-link-balance">Not Connected</span></p>
            <p>Stored ETH Balance: <span id="stored-eth-balance">Not Connected</span></p>
        </div>
        <div class="form-group transfer-form">
            <input type="text" id="recipient" placeholder="Recipient Address">
            <input type="number" id="transfer-amount" min="0" step="0.001" placeholder="Amount (ETH)">
            <button onclick="transferValue()" class="transfer-button">Transfer</button>
        </div>
        <div class="form-group">
            <button onclick="viewTransactions()">View Transactions</button>
            <div id="transactions"></div>
        </div>
        <div id="transaction-info"></div>
        <a href="/main" class="button">Back to Main</a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const contractAddress = "0xD306EE4271c6FC7F87D587a00d00B15746C3d174";
        const contractABI = [
            "function transferValue(address payable to, uint256 amount) external",
            "function getStoredValue() external view returns (uint256)"
        ];
        const linkTokenAddress = "0x779877A7B0D9E8603169DdbD7836e478b4624789"; // Sepolia Chain Link Token address
        const linkTokenABI = [
            "function balanceOf(address account) external view returns (uint256)"
        ];

        let provider;
        let signer;
        let contract;
        let linkToken;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    linkToken = new ethers.Contract(linkTokenAddress, linkTokenABI, signer);
                    await updateWalletInfo();
                } catch (error) {
                    console.error("Error connecting wallet:", error);
                    alert("Failed to connect wallet.");
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        async function updateWalletInfo() {
            try {
                const address = await signer.getAddress();
                const ethBalance = await provider.getBalance(address);
                const linkBalance = await linkToken.balanceOf(address);
                const storedValue = await contract.getStoredValue();
                
                document.getElementById('wallet-eth-balance').innerText = `${ethers.utils.formatEther(ethBalance)} ETH`;
                document.getElementById('wallet-link-balance').innerText = `${ethers.utils.formatEther(linkBalance)} LINK`;
                document.getElementById('stored-eth-amount').innerText = `${ethers.utils.formatEther(storedValue)} ETH`;
            } catch (error) {
                console.error("Error updating wallet info:", error);
            }
        }

        async function transferValue() {
            const recipient = document.getElementById('recipient').value;
            const amount = document.getElementById('transfer-amount').value;
            if (!ethers.utils.isAddress(recipient)) {
                alert("Invalid recipient address.");
                return;
            }
            try {
                const tx = await contract.transferValue(recipient, ethers.utils.parseEther(amount));
                await tx.wait();
                alert("Value transferred successfully!");
                await updateWalletInfo();
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while transferring the value.");
            }
        }

        async function viewTransactions() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const address = await signer.getAddress();
                    console.log("Fetching transactions for address:", address);
                    const transactions = await provider.getHistory(address);
                    console.log("Transactions fetched:", transactions);

                    if (transactions.length === 0) {
                        document.getElementById('transactions').innerHTML = "<p>No transactions found.</p>";
                        return;
                    }

                    // 过滤与智能合约相关的交易
                    const contractTransactions = transactions.filter(tx => tx.to && tx.to.toLowerCase() === contractAddress.toLowerCase());

                    if (contractTransactions.length === 0) {
                        document.getElementById('transactions').innerHTML = "<p>No transactions with the contract found.</p>";
                        return;
                    }

                    // 仅展示最近5笔交易
                    const recentTxs = contractTransactions.slice(-5).reverse();

                    const transactionsDiv = document.getElementById('transactions');
                    transactionsDiv.innerHTML = "<h3>Recent Transactions:</h3>";

                    recentTxs.forEach((tx, index) => {
                        const sender = tx.from;
                        const receiver = tx.to;
                        const amount = ethers.utils.formatEther(tx.value);
                        transactionsDiv.innerHTML += `
                            <div class="transaction">
                                <p><strong>Transaction ${index + 1}:</strong></p>
                                <p>Sender: ${sender}</p>
                                <p>Receiver: ${receiver}</p>
                                <p>Amount: ${amount} ETH</p>
                                <hr>
                            </div>
                        `;
                    });

                } catch (error) {
                    console.error("Error fetching transactions:", error);
                    alert("An error occurred while fetching transactions.");
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        window.onload = function() {
            if (localStorage.getItem('walletConnected') === 'true') {
                connectWallet();
            }
        }
    </script>
</body>
</html>
